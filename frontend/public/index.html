<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–í–∏–¥–µ–æ—á–∞—Ç –†–æ—Å—Å–∏—è</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial; background: #1a202c; color: white; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: #2d3748; padding: 30px; border-radius: 10px; margin: 20px 0; }
        .btn { background: #4299e1; color: white; border: none; padding: 12px 24px; margin: 5px; border-radius: 5px; cursor: pointer; }
        .btn:hover { background: #3182ce; }
        .btn-success { background: #48bb78; }
        .btn-danger { background: #f56565; }
        .cities { display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0; }
        .videos { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        video { width: 100%; background: #000; border: 2px solid #4a5568; border-radius: 5px; }
        .status { padding: 10px; background: #4a5568; border-radius: 5px; margin: 10px 0; text-align: center; }
        @media (max-width: 768px) {
            .videos { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üé• –í–∏–¥–µ–æ—á–∞—Ç –ø–æ –≥–æ—Ä–æ–¥–∞–º –†–æ—Å—Å–∏–∏</h1>
            <div id="status" class="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
            
            <!-- –í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞ -->
            <div id="citySelection">
                <h2>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥:</h2>
                <div class="cities" id="citiesList"></div>
            </div>
            
            <!-- –í–∏–¥–µ–æ—á–∞—Ç -->
            <div id="videoChat" style="display: none;">
                <h2 id="currentCity"></h2>
                <div class="controls">
                    <button class="btn btn-success" onclick="findPartner()">üîç –ù–∞–π—Ç–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</button>
                    <button class="btn btn-danger" onclick="endCall()" style="display: none;">üìû –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                    <button class="btn" onclick="leaveCity()">üö™ –°–º–µ–Ω–∏—Ç—å –≥–æ—Ä–æ–¥</button>
                </div>
                
                <div class="videos">
                    <div>
                        <h3>–í–∞—à–∞ –∫–∞–º–µ—Ä–∞</h3>
                        <video id="localVideo" autoplay muted playsinline></video>
                    </div>
                    <div>
                        <h3>–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</h3>
                        <video id="remoteVideo" autoplay playsinline></video>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥
        const SOCKET_URL = location.hostname === 'localhost' ? 'http://localhost:5000' : window.location.origin;
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let socket, currentCity, partnerId, peerConnection, localStream;
        const cities = ['–ú–æ—Å–∫–≤–∞', '–°–ü–±', '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', '–ö–∞–∑–∞–Ω—å', '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥'];
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            renderCities();
            connectSocket();
        }
        
        function renderCities() {
            document.getElementById('citiesList').innerHTML = cities.map(city => 
                `<button class="btn" onclick="joinCity('${city}')">${city}</button>`
            ).join('');
        }
        
        function connectSocket() {
            socket = io(SOCKET_URL);
            
            socket.on('connected', (data) => {
                updateStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
            });
            
            socket.on('room-joined', (room) => {
                updateStatus(`‚úÖ –í –∫–æ–º–Ω–∞—Ç–µ: ${room}`);
            });
            
            socket.on('partner-found', (id) => {
                partnerId = id;
                updateStatus('‚úÖ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω!');
                startCall(id);
                document.querySelector('.btn-success').style.display = 'none';
                document.querySelector('.btn-danger').style.display = 'inline-block';
            });
            
            socket.on('waiting-partner', () => {
                updateStatus('üîç –ò—â–µ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...');
            });
            
            socket.on('partner-left', () => {
                updateStatus('‚ùå –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ —É—à–µ–ª');
                endCall();
            });
            
            // WebRTC
            socket.on('offer', handleOffer);
            socket.on('answer', handleAnswer);
            socket.on('ice-candidate', handleIceCandidate);
        }
        
        async function joinCity(city) {
            currentCity = city;
            socket.emit('join-room', city);
            document.getElementById('currentCity').textContent = `–ì–æ—Ä–æ–¥: ${city}`;
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
            } catch (error) {
                alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ!');
                return;
            }
            
            document.getElementById('citySelection').style.display = 'none';
            document.getElementById('videoChat').style.display = 'block';
        }
        
        function findPartner() {
            socket.emit('find-partner', currentCity);
        }
        
        function startCall(targetId) {
            if (!localStream) return;
            
            peerConnection = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' }
                ]
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            // –ü–æ–ª—É—á–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ
            peerConnection.ontrack = (event) => {
                document.getElementById('remoteVideo').srcObject = event.streams[0];
            };
            
            // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice-candidate', { target: targetId, candidate: event.candidate });
                }
            };
            
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
            peerConnection.createOffer()
                .then(offer => peerConnection.setLocalDescription(offer))
                .then(() => {
                    socket.emit('offer', { target: targetId, offer: peerConnection.localDescription });
                });
        }
        
        async function handleOffer(data) {
            if (!peerConnection) return;
            await peerConnection.setRemoteDescription(data.offer);
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('answer', { target: data.sender, answer: answer });
        }
        
        async function handleAnswer(data) {
            if (!peerConnection) return;
            await peerConnection.setRemoteDescription(data.answer);
        }
        
        async function handleIceCandidate(data) {
            if (!peerConnection) return;
            await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
        
        function endCall() {
            if (peerConnection) peerConnection.close();
            partnerId = null;
            document.querySelector('.btn-success').style.display = 'inline-block';
            document.querySelector('.btn-danger').style.display = 'none';
            updateStatus('–ì–æ—Ç–æ–≤ –∫ –ø–æ–∏—Å–∫—É');
        }
        
        function leaveCity() {
            endCall();
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            document.getElementById('citySelection').style.display = 'block';
            document.getElementById('videoChat').style.display = 'none';
            updateStatus('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥');
        }
        
        function updateStatus(msg) {
            document.getElementById('status').textContent = msg;
        }
        
        // –ó–∞–ø—É—Å–∫
        window.onload = init;
    </script>
</body>
</html>