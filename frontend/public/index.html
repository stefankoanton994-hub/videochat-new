<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–í–∏–¥–µ–æ—á–∞—Ç –ø–æ –≥–æ—Ä–æ–¥–∞–º –†–æ—Å—Å–∏–∏</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial; background: #1a202c; color: white; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: #2d3748; padding: 30px; border-radius: 15px; }
        h1 { text-align: center; margin-bottom: 30px; color: #4299e1; }
        .cities { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 20px 0; }
        .btn { background: #4299e1; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-size: 16px; }
        .btn:hover { background: #3182ce; }
        .btn-success { background: #48bb78; }
        .btn-danger { background: #f56565; }
        .btn-warning { background: #ed8936; }
        .video-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0; }
        video { width: 100%; background: #000; border: 3px solid #4a5568; border-radius: 10px; }
        .status { padding: 15px; background: #4a5568; border-radius: 8px; margin: 15px 0; text-align: center; font-weight: bold; }
        .controls { display: flex; gap: 10px; justify-content: center; margin: 20px 0; flex-wrap: wrap; }
        @media (max-width: 768px) {
            .video-container { grid-template-columns: 1fr; }
            .cities { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• –í–∏–¥–µ–æ—á–∞—Ç –ø–æ –≥–æ—Ä–æ–¥–∞–º –†–æ—Å—Å–∏–∏</h1>
        <div id="status" class="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
        
        <div id="citySelection">
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –≥–æ—Ä–æ–¥:</h2>
            <div class="cities" id="citiesList"></div>
        </div>
        
        <div id="videoChat" style="display: none;">
            <h2 id="currentCity"></h2>
            <div class="controls">
                <button class="btn btn-success" onclick="findPartner()">üîç –ù–∞–π—Ç–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</button>
                <button class="btn btn-danger" onclick="endCall()" style="display: none;">üìû –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                <button class="btn btn-warning" onclick="leaveCity()">üö™ –°–º–µ–Ω–∏—Ç—å –≥–æ—Ä–æ–¥</button>
            </div>
            
            <div class="video-container">
                <div>
                    <h3>–í–∞—à–µ –≤–∏–¥–µ–æ</h3>
                    <video id="localVideo" autoplay muted playsinline></video>
                </div>
                <div>
                    <h3>–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</h3>
                    <video id="remoteVideo" autoplay playsinline></video>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const SOCKET_URL = window.location.origin;
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let socket, currentCity, partnerId, peerConnection, localStream;
        const cities = ['–ú–æ—Å–∫–≤–∞', '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', '–ö–∞–∑–∞–Ω—å', '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥', '–ß–µ–ª—è–±–∏–Ω—Å–∫', '–°–∞–º–∞—Ä–∞', '–û–º—Å–∫', '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É'];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            renderCities();
            connectSocket();
        }

        function renderCities() {
            document.getElementById('citiesList').innerHTML = cities.map(city => 
                `<button class="btn" onclick="joinCity('${city}')">${city}</button>`
            ).join('');
        }

        function connectSocket() {
            socket = io(SOCKET_URL, {
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                updateStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
            });

            socket.on('room-joined', (room) => {
                updateStatus(`‚úÖ –í –∫–æ–º–Ω–∞—Ç–µ: ${room}`);
            });

            socket.on('partner-found', (id) => {
                partnerId = id;
                updateStatus('‚úÖ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω! –°–æ–µ–¥–∏–Ω—è–µ–º...');
                startWebRTC(id);
                document.querySelector('.btn-success').style.display = 'none';
                document.querySelector('.btn-danger').style.display = 'inline-block';
            });

            socket.on('waiting-partner', () => {
                updateStatus('üîç –ò—â–µ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –≤ –≤–∞—à–µ–º –≥–æ—Ä–æ–¥–µ...');
            });

            // WebRTC —Å–æ–±—ã—Ç–∏—è
            socket.on('webrtc-offer', handleOffer);
            socket.on('webrtc-answer', handleAnswer);
            socket.on('webrtc-ice-candidate', handleIceCandidate);
        }

        async function joinCity(city) {
            currentCity = city;
            socket.emit('join-room', city);
            document.getElementById('currentCity').textContent = `–ì–æ—Ä–æ–¥: ${city}`;
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 1280, height: 720 },
                    audio: true 
                });
                document.getElementById('localVideo').srcObject = localStream;
                updateStatus('‚úÖ –ö–∞–º–µ—Ä–∞ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –≥–æ—Ç–æ–≤—ã');
            } catch (error) {
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ');
                alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É!');
                return;
            }
            
            document.getElementById('citySelection').style.display = 'none';
            document.getElementById('videoChat').style.display = 'block';
        }

        function findPartner() {
            if (!currentCity) return;
            socket.emit('find-partner', currentCity);
            updateStatus('üîç –ò—â–µ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...');
        }

        function startWebRTC(targetId) {
            if (!localStream) return;

            // –ù–ê–î–ï–ñ–ù–´–ï TURN –°–ï–†–í–ï–†–´ –î–õ–Ø –ò–ù–¢–ï–†–ù–ï–¢–ê
            peerConnection = new RTCPeerConnection({
                iceServers: [
                    // Google STUN
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' },
                    { urls: 'stun:stun4.l.google.com:19302' },
                    
                    // –ü—É–±–ª–∏—á–Ω—ã–µ TURN —Å–µ—Ä–≤–µ—Ä—ã
                    {
                        urls: 'turn:openrelay.metered.ca:80',
                        username: 'openrelayproject',
                        credential: 'openrelayproject'
                    },
                    {
                        urls: 'turn:openrelay.metered.ca:443',
                        username: 'openrelayproject',
                        credential: 'openrelayproject'
                    },
                    {
                        urls: 'turn:openrelay.metered.ca:443?transport=tcp',
                        username: 'openrelayproject',
                        credential: 'openrelayproject'
                    }
                ],
                iceTransportPolicy: 'all'
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ
            peerConnection.ontrack = (event) => {
                console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫');
                const remoteVideo = document.getElementById('remoteVideo');
                if (event.streams && event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                    updateStatus('‚úÖ –í–∏–¥–µ–æ—Å–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!');
                }
            };

            // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('webrtc-ice-candidate', {
                        candidate: event.candidate,
                        target: targetId
                    });
                }
            };

            // –°—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            peerConnection.onconnectionstatechange = () => {
                console.log('Connection state:', peerConnection.connectionState);
            };

            // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
            peerConnection.createOffer({
                offerToReceiveAudio: true,
                offerToReceiveVideo: true
            })
            .then(offer => peerConnection.setLocalDescription(offer))
            .then(() => {
                socket.emit('webrtc-offer', {
                    offer: peerConnection.localDescription,
                    target: targetId
                });
            })
            .catch(error => {
                console.error('Offer error:', error);
                updateStatus('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            });
        }

        async function handleOffer(data) {
            if (!peerConnection) return;
            
            try {
                await peerConnection.setRemoteDescription(data.offer);
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                socket.emit('webrtc-answer', {
                    answer: answer,
                    target: data.sender
                });
            } catch (error) {
                console.error('Handle offer error:', error);
            }
        }

        async function handleAnswer(data) {
            if (!peerConnection) return;
            try {
                await peerConnection.setRemoteDescription(data.answer);
            } catch (error) {
                console.error('Handle answer error:', error);
            }
        }

        async function handleIceCandidate(data) {
            if (!peerConnection) return;
            try {
                await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
            } catch (error) {
                console.error('Handle ICE candidate error:', error);
            }
        }

        function endCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            partnerId = null;
            
            const remoteVideo = document.getElementById('remoteVideo');
            if (remoteVideo.srcObject) {
                remoteVideo.srcObject.getTracks().forEach(track => track.stop());
                remoteVideo.srcObject = null;
            }
            
            document.querySelector('.btn-success').style.display = 'inline-block';
            document.querySelector('.btn-danger').style.display = 'none';
            updateStatus('–ì–æ—Ç–æ–≤ –∫ –ø–æ–∏—Å–∫—É —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞');
        }

        function leaveCity() {
            endCall();
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('citySelection').style.display = 'block';
            document.getElementById('videoChat').style.display = 'none';
            updateStatus('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥');
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // –ó–∞–ø—É—Å–∫
        window.onload = init;
    </script>
</body>
</html>